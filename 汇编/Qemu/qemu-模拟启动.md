# 1 qemu-system-x86_64 -drive format=raw,file=boot.bin

这行命令的作用是直接将一个 **二进制引导程序文件** (`boot.bin`) 当作虚拟磁盘的镜像文件运行，并使用 QEMU 模拟其启动。下面逐部分解析：

---

### 命令详解

#### 1. **`qemu-system-x86_64`**
- 启动 QEMU 模拟器。
- `x86_64` 表示模拟的是 64 位 x86 架构。

#### 2. **`-drive format=raw`**
- 指定虚拟驱动器的参数。
- `format=raw`：告诉 QEMU，文件的格式是原始二进制（**raw**）。  
  **raw** 格式是最基础的磁盘映像格式，文件内容直接映射为磁盘的字节，不包含元数据。

#### 3. **`file=boot.bin`**
- 指定用作虚拟磁盘的文件，这里是 `boot.bin`。
- **`boot.bin`** 是一个二进制文件，通常是用汇编代码编译出来的引导程序。

---

### 工作原理

1. QEMU 将 `boot.bin` 文件视为一个磁盘镜像，并加载到模拟器中。
2. 在传统的 x86 架构下，BIOS 会尝试从磁盘的第一个扇区（即偏移 0x0 到 0x1FF，512 字节）加载引导程序到内存地址 `0x7C00` 并执行。
3. `boot.bin` 文件需要包含完整的引导代码，并以 0xAA55 结尾（引导签名），否则 BIOS 不会识别它为有效的引导扇区。

---

### 为什么可以直接使用 `boot.bin`？

通常，我们会将引导程序放入磁盘镜像（如 `floppy.img` 或 `disk.img`），但 QEMU 提供了快捷方式：如果文件是一个符合引导扇区格式的二进制文件，可以直接使用它作为原始磁盘映像。

---

### 注意事项

- **大小限制**：  
  `boot.bin` 文件的大小必须为 512 字节（引导扇区大小）。如果不足 512 字节，可以在汇编代码中使用填充，例如：

  ```asm
  times 510-($-$$) db 0   ; 填充到 510 字节
  dw 0xAA55               ; 引导扇区标志
  ```

- **文件格式**：  
  必须是裸机引导代码，不能包含文件系统信息。

---

### 示例用法

假设 `boot.asm` 是以下简单的引导程序：

```asm
org 0x7C00       ; BIOS 加载地址
mov ah, 0x0E     ; BIOS 中断功能号，用于打印字符
mov al, 'H'
int 0x10         ; 打印 'H'
jmp $            ; 停机

times 510-($-$$) db 0   ; 填充至 512 字节
dw 0xAA55               ; 引导扇区标志
```

1. 编译引导程序：

   ```bash
   nasm -f bin boot.asm -o boot.bin
   ```

2. 使用 QEMU 直接运行：

   ```bash
   qemu-system-x86_64 -drive format=raw,file=boot.bin
   ```

启动后，QEMU 将显示字符 `H`。

---

### 总结

这条命令可以直接运行一个引导扇区的二进制文件，而不需要将它嵌入到磁盘镜像中。它是开发和调试裸机引导程序时的便捷方式。


# 2 emu-system-x86_64 -fda floppy.img 这个和上面的有什么不同

`qemu-system-x86_64 -fda floppy.img` 和 `qemu-system-x86_64 -drive format=raw,file=boot.bin` 都是用来运行 QEMU 模拟器，但它们的用法和目标稍有不同，以下是它们的区别：

---

### **1. `-fda floppy.img`**

#### 含义：
- `-fda`：表示将指定的文件 (`floppy.img`) 挂载为**虚拟软盘驱动器 A:（floppy disk A）**。
- `floppy.img`：这是一个**完整的软盘镜像文件**，通常为 1.44MB 大小，可能包含文件系统、多个扇区等数据。

#### 工作原理：
- 模拟一个软盘设备（A:），BIOS 会从这个设备的第一个扇区（引导扇区）加载代码。
- `floppy.img` 通常是一个包含引导扇区的软盘镜像，格式类似于真实的软盘。

---

### **2. `-drive format=raw,file=boot.bin`**

#### 含义：
- `-drive`：将一个文件 (`boot.bin`) 挂载为 QEMU 的虚拟磁盘驱动器。
- `format=raw`：明确告诉 QEMU，文件是原始数据，不包含元数据或文件系统。

#### 工作原理：
- 直接使用一个二进制文件作为虚拟磁盘的内容，模拟一个裸机引导过程。
- 这里的 `boot.bin` 通常是单个扇区大小（512 字节）的裸机引导程序，而不像 `floppy.img` 那样包含整个磁盘的内容。

---

### **主要区别**

| 特性                     | `-fda floppy.img`                                         | `-drive format=raw,file=boot.bin`                   |
|--------------------------|----------------------------------------------------------|----------------------------------------------------|
| **文件类型**             | 完整的软盘镜像，可能包含文件系统和多个扇区数据。         | 单个裸机引导扇区文件，通常是 512 字节。             |
| **设备类型**             | 模拟软盘驱动器 A:                                        | 模拟一个磁盘设备                                   |
| **适用场景**             | 测试含文件系统的软盘或完整的磁盘镜像                     | 测试单个裸机引导程序                               |
| **引导扇区位置**         | 镜像文件的第一个扇区（引导扇区）                         | 文件的所有内容即为引导扇区                         |
| **文件大小**             | 通常为 1.44MB 或更大                                     | 通常为 512 字节                                    |

---

### **使用示例**

#### **1. 使用软盘镜像 (`-fda floppy.img`)**
适合需要包含多个文件或多个扇区内容的软盘，例如：

1. 制作软盘镜像：
   ```bash
   bximage -fd=1.44M -q floppy.img
   ```

2. 将引导程序写入镜像：
   ```bash
   dd if=boot.bin of=floppy.img bs=512 count=1 conv=notrunc
   ```

3. 用 QEMU 启动：
   ```bash
   qemu-system-x86_64 -fda floppy.img
   ```

此方法可以模拟一个完整软盘，其中不仅可以有引导程序，还可以包含文件系统或其他数据。

---

#### **2. 直接运行裸机引导程序 (`-drive`)**
适合仅测试引导扇区代码：

1. 编写一个裸机引导程序，确保大小为 512 字节。
2. 用 QEMU 直接加载：
   ```bash
   qemu-system-x86_64 -drive format=raw,file=boot.bin
   ```

此方法简单快捷，适合快速测试引导扇区。

---

### **总结**
- `-fda` 更贴近实际设备（软盘驱动器）的模拟，适合复杂镜像的场景。
- `-drive` 更适合测试裸机引导程序，简化了开发和调试流程。
