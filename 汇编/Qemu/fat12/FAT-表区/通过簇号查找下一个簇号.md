# 1 通过起始簇号查找下一个簇号

在 FAT12 文件系统中，如果内核文件的起始簇号是 `3`，要找到文件的下一个簇号，需要依赖 **FAT 表**。FAT 表通过链表的方式记录了每个簇的“下一个簇号”，从而实现文件的簇链。以下是具体的过程：

---

### **1. 找到 FAT 表中的对应表项**
- 起始簇号是 `3`，需要在 FAT 表中查找第 `3` 个表项的内容。
- 每个表项占用 **12 比特**，所以需要通过以下计算找到它的存储位置：
  1. **计算表项起始比特位置**：
     ```
     起始比特位置 = 簇号 × 12
     ```
     对于簇号 `3`：
     ```
     起始比特位置 = 3 × 12 = 36 位
     ```
  2. **找到起始字节位置**：
     ```
     起始字节 = 起始比特位置 ÷ 8 = 36 ÷ 8 = 4 字节（从 0 开始计数）
     ```
  3. 表项数据跨越了第 `4` 和第 `5` 字节（共 12 比特）。

---

### **2. 提取和解析表项数据**
- 表项的 12 比特可能分布在两个相邻的字节中，需要通过以下方式提取：
  - 提取第 `4` 和第 `5` 字节的数据。
  - 根据表项索引的奇偶性决定如何解析（FAT12 表项交错存储）：
    - **偶数簇号**：低 8 比特在当前字节，高 4 比特在下一个字节。
    - **奇数簇号**：高 4 比特在当前字节，低 8 比特在下一个字节。
- 簇号 `3` 是 **奇数**，所以解析方式是：
  - 从第 `4` 字节提取高 4 比特。
  - 从第 `5` 字节提取低 8 比特。
  - 拼接后得到完整的 12 比特。

---

### **3. 读取解析后的簇号**
- 解析出的 12 比特即是下一个簇号。
- 如果下一个簇号为：
  - **有效簇号（如 4、5、6）**：表示文件继续存储在这些簇中。
  - **特殊标记（如 0xFFF 或 0xFF8–0xFFF）**：表示当前簇是文件的最后一个簇。
  - **坏簇标记（如 0xFF7）**：表示文件存储出错。

---

### **4. 重复上述过程**
- 如果下一个簇号有效，则重复步骤 1~3，查找下一个簇号，直到遇到结束标记。

---

### **示例**
假设起始簇号为 `3`，以下是具体步骤：
1. 起始簇号 `3` 的起始比特位置：
   ```
   起始比特位置 = 3 × 12 = 36 位
   起始字节 = 36 ÷ 8 = 4 字节
   ```
2. 表项数据在第 `4` 和第 `5` 字节：
   - 第 `4` 字节为：`0x56`（二进制：0101 0110）。
   - 第 `5` 字节为：`0x34`（二进制：0011 0100）。
3. 拼接表项数据（奇数簇号）：
   ```
   高 4 比特：第 4 字节的低 4 比特 = 0110
   低 8 比特：第 5 字节的全部 = 0011 0100
   表项值 = 0x0634（16 进制） = 簇号 1590
   ```
4. 下一个簇号为 `1590`，重复此过程找到下一个簇。

---

### **总结**
通过 FAT 表查找文件的下一个簇号的步骤：
1. 根据簇号计算表项在 FAT 表中的位置。
2. 读取相关字节并解析出 12 比特。
3. 检查解析结果，判断是否是有效簇号、结束标记或错误标记。
4. 如果是有效簇号，重复操作，直到找到文件的最后一个簇。
