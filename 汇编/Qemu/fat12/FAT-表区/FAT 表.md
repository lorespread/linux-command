# 1 详解 FAT 表

FAT（File Allocation Table）是一种广泛使用的文件系统结构，最初由微软为 MS-DOS 设计，并被许多操作系统和存储设备（如闪存驱动器、SD 卡）采用。FAT 文件系统的核心是**FAT 表**，它管理磁盘上的文件存储位置。下面是详细的讲解。

### **FAT 表的基本概念**

FAT 表是磁盘上的一个表格，它记录了每个文件在磁盘上的存储位置。FAT 表的每个条目（项）指向文件存储的下一个簇（cluster）的位置。簇是文件系统中的基本存储单元，通常是一个扇区的多倍（例如，512 字节的扇区和 2048 字节或更大的簇）。

### **FAT 表的结构**

FAT 表的结构由以下几部分组成：

1. **FAT 表本身**：
   FAT 表由一个或多个表组成，通常根据磁盘的大小和 FAT 的版本（FAT12、FAT16、FAT32）来决定 FAT 表的数量。它包含多个条目，每个条目对应一个簇。
   
2. **簇（Cluster）**：
   磁盘被分割为多个簇，每个簇由一组扇区组成。簇是文件系统中的最小分配单位。不同的 FAT 版本支持不同大小的簇。
   
3. **FAT 表的条目**：
   每个条目是一个**簇号**，它表示该簇中存储的文件数据的下一个簇。通过 FAT 表中的这些条目，文件系统可以知道文件的所有簇如何链接起来。

4. **保留簇**：
   一开始，FAT 表的前几个条目被保留，以表示特殊信息。通常，**FAT0**和**FAT1**的条目被用来存储备份。

### **FAT 的工作原理**

FAT 表的工作原理基于链式结构。每个簇在 FAT 表中有一个对应的条目，该条目存储下一个簇的地址（如果有）。文件由一个或多个簇组成，FAT 表中的条目指向这些簇。

例如，如果文件占用了 3 个簇，FAT 表的工作流程如下：
1. FAT 表为文件的第一个簇记录下第二个簇的簇号。
2. FAT 表为文件的第二个簇记录下第三个簇的簇号。
3. FAT 表为文件的第三个簇记录“结束标志”，表示文件的最后一个簇。

通过这种链式结构，FAT 文件系统能够有效地管理文件在磁盘上的存储位置。

### **FAT 表的类型**

根据簇的大小和 FAT 表条目的位数，FAT 有多个版本：
- **FAT12**：适用于较小的存储设备，最多支持 2^12 (4096) 个簇。每个簇条目占用 12 位。
- **FAT16**：适用于稍大的设备，最多支持 2^16 (65536) 个簇，每个簇条目占用 16 位。
- **FAT32**：支持更大的存储设备，最多支持 2^28 (268435456) 个簇，每个簇条目占用 32 位。

每个版本的 FAT 文件系统对存储设备的大小和簇的大小有不同的限制和要求。

### **FAT 表的具体内容**

FAT 表的条目可以具有以下几种状态：

1. **有效簇（Valid Cluster）**：
   每个簇条目包含下一个簇的地址。如果该簇是文件的一部分，它将包含指向下一个簇的地址。

2. **结束标志（End of File, EOF）**：
   每个文件的最后一个簇会有一个特殊的结束标志，表示该文件在磁盘上的结尾。通常是一个大于簇总数的值，如：
   - **FAT12**：0xFF8 到 0xFFF
   - **FAT16**：0xFFF8 到 0xFFFF
   - **FAT32**：0x0FFFFFF8 到 0x0FFFFFFF

3. **空闲簇（Free Cluster）**：
   空闲簇表示该簇未被任何文件使用，FAT 表中的条目指向“空闲”，通常是 0x000。

4. **坏簇（Bad Cluster）**：
   坏簇表示该簇已损坏，无法用于存储数据。FAT 表中对应条目的值通常是 0xFFF7（FAT16）或 0x0FFFFFF7（FAT32）。

### **FAT 表的管理与更新**

FAT 表在磁盘的整个生命周期内需要进行动态更新。当文件创建、删除、移动时，FAT 表会相应更新：
- **创建文件**：为文件分配新的簇，并在 FAT 表中更新相应的簇链。
- **删除文件**：清除文件簇的 FAT 表条目，标记为可用。
- **扩展文件**：如果文件需要更多的空间，FAT 表会找到空闲簇并进行链式扩展。
- **文件收缩**：当文件缩小时，FAT 表会释放不再需要的簇，并将它们标记为空闲簇。

### **FAT 表的优缺点**

#### 优点：
1. **简单性**：FAT 文件系统的结构简单，易于实现。
2. **兼容性**：FAT 文件系统被广泛支持，几乎所有操作系统都能识别和读取 FAT 格式的磁盘。
3. **适用性广泛**：尤其适用于小型设备和存储介质，如 U 盘、SD 卡等。

#### 缺点：
1. **效率低**：在大容量存储设备上，FAT 文件系统的效率较低，尤其在簇大小增大时，存储空间的浪费较严重。
2. **碎片化**：由于簇的大小是固定的，文件频繁变化时容易导致磁盘碎片。
3. **性能问题**：当文件系统变得非常大时，FAT 表的查找效率降低。

### **FAT 表的实际使用**

FAT 文件系统常用于许多存储设备，尤其是：
- **闪存驱动器（U 盘）**
- **SD 卡**
- **嵌入式设备**
- **小型存储设备（如数码相机、MP3 播放器等）**

它的简单性和广泛的兼容性使得 FAT 文件系统成为这些设备的首选。

### **总结**

FAT 表是 FAT 文件系统的核心部分，通过链式管理文件在磁盘上的存储位置。FAT 表的工作原理是通过在每个簇的条目中存储下一个簇的地址，实现对文件存储簇的跟踪。虽然 FAT 文件系统具有简单、兼容性强的优点，但它在大容量存储和碎片管理方面存在局限性。

# 2 详细讲解下 FAT12 中 FAT 表的结构
