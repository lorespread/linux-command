# 1 如何通过根目录中的条目查找其对应的簇号

在 FAT12 的根目录区，每个目录条目占用 32 个字节，其中第 **26-27 字节** 存储了文件的 **起始簇号**。通过这个起始簇号，就可以进入 FAT 表找到文件的簇链，从而定位文件的所有数据簇。

以下是找到簇号的具体步骤和原理：

---

### 1. **根目录条目结构回顾**
每个目录条目的内容分布如下（只列出相关部分）：
- **偏移 26-27**：起始簇号，占用 2 个字节，表示文件的第一个簇号。

例如：
```
+--------+-------------------+
| 偏移量 | 内容              |
+--------+-------------------+
| 26-27  | 起始簇号（2字节） |
+--------+-------------------+
```

- 起始簇号是一个 16 位值，但 FAT12 文件系统中只用到低 12 位。

---

### 2. **从目录条目提取起始簇号**
当在根目录找到目标文件条目后：
1. 读取目录条目偏移 26-27 的 2 个字节内容。
2. 将这两个字节合并为一个 16 位的值：
   - **低字节**：直接存储在偏移 26。
   - **高字节**：存储在偏移 27。
3. 提取到的值就是文件的 **起始簇号**。

**示例：**
目录条目中，偏移 26-27 的内容为：
```
偏移 26: 0x03
偏移 27: 0x00
```
合并后起始簇号为：
```
0x0003
```
表示文件从簇号 `3` 开始。

---

### 3. **通过起始簇号访问数据簇**
起始簇号指向文件数据的第一个簇，接下来需要通过 FAT 表找到簇链，访问所有簇的数据。

#### 簇链解析过程：
1. **读取起始簇的数据**：
   - 数据簇起始位置 = 数据区起始地址 + (起始簇号 - 2) × 每簇大小。
   - 因为簇号从 2 开始，表示逻辑上的第一个簇。
   
2. **读取 FAT 表，找到下一簇**：
   - 在 FAT 表中找到起始簇号对应的表项，表项存储了下一个簇号。
   - 如果表项的值是 `0xFFF`（文件结束标记），说明文件读取完成。
   - 如果表项的值是 `0x000`（空簇），说明发生了错误。

3. **重复访问所有簇**：
   - 根据 FAT 表中的簇链，依次读取每个簇的数据，直到遇到文件结束标记。

---

### 4. **示例解析过程**
假设：
- 数据区起始地址：`0x2000`。
- 每簇大小：512 字节。
- 根目录条目中起始簇号：`0x0003`。
- FAT 表内容：
  - 簇号 `3` 对应表项值为 `4`。
  - 簇号 `4` 对应表项值为 `5`。
  - 簇号 `5` 对应表项值为 `0xFFF`（文件结束）。

#### 步骤：
1. **读取起始簇号 `0x0003`**：
   - 数据地址 = `0x2000 + (3 - 2) × 512 = 0x2000 + 512 = 0x2200`。

2. **查 FAT 表，找到下一个簇 `4`**：
   - 查找 FAT 表簇号 `3` 的表项值，值为 `4`。

3. **读取簇 `4` 数据**：
   - 数据地址 = `0x2000 + (4 - 2) × 512 = 0x2000 + 1024 = 0x2400`。

4. **查 FAT 表，找到下一个簇 `5`**：
   - 查找 FAT 表簇号 `4` 的表项值，值为 `5`。

5. **读取簇 `5` 数据**：
   - 数据地址 = `0x2000 + (5 - 2) × 512 = 0x2000 + 1536 = 0x2600`。

6. **查 FAT 表，发现簇号 `5` 的表项值为 `0xFFF`**：
   - 文件结束。

---

### 5. **总结**
通过根目录条目的起始簇号可以定位文件的第一簇，再通过 FAT 表的簇链找到所有数据簇。整个过程利用了 FAT 表的链式存储机制，确保可以访问大文件跨多个簇存储的数据。

